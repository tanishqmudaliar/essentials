name: Auto-Renew PythonAnywhere

on:
  schedule:
    # Run at 04:00 UTC on the 1st and 15th of every month
    # (Updated for the new 1-month expiry policy)
    - cron: '0 4 1,15 * *'
  workflow_dispatch: # Allows manual run from GitHub Actions tab

jobs:
  renew_and_keepalive:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for the keepalive action to push commits
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for keepalive to work

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests beautifulsoup4 python-dotenv

      - name: Run renewal script
        env:
          PA_USERNAME: ${{ secrets.PA_USERNAME }}
          PA_PASSWORD: ${{ secrets.PA_PASSWORD }}
        run: python renew_app.py

      # --- KEEP ALIVE SECTION (DIY - No external action needed) ---
      - name: Keep Workflow Alive
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get days since last commit
          LAST_COMMIT=$(git log -1 --format=%ct)
          CURRENT_TIME=$(date +%s)
          DAYS_SINCE=$((($CURRENT_TIME - $LAST_COMMIT) / 86400))
          
          echo "Days since last commit: $DAYS_SINCE"
          
          # If more than 50 days, make a keepalive commit
          if [ $DAYS_SINCE -gt 50 ]; then
            echo "Making keepalive commit..."
            git commit --allow-empty -m "chore: keepalive commit to prevent workflow disable"
            git push
          else
            echo "No keepalive needed yet (threshold: 50 days)"
          fi
